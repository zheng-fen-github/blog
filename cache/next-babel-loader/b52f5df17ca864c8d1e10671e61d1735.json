{"ast":null,"code":"import _JSXStyle from \"styled-jsx/style\";\nvar __jsx = React.createElement;\nimport React, { useEffect, useState } from 'react';\nimport Head from 'next/head';\nimport Nav from '../component/release-article/nav';\nimport Author from '../component/release-article/author';\nimport ArtContent from '../component/release-article/articleContent';\nimport About from '../component/release-article/about';\nimport Footer from '../component/release-article/footer';\nimport { useRouter } from 'next/router';\n\nconst Home = () => {\n  let {\n    key\n  } = useRouter().query; //设置发布的钥匙串\n\n  useEffect(() => {\n    if (key) localStorage.setItem('article-key', key);\n  }, []);\n\n  const uploadData = async data => {\n    try {\n      const QURL = process.env.DATA_URL + 'addArticle/add';\n      let res = await fetch(QURL, {\n        method: 'POST',\n        body: data\n      });\n      let result = await res.json();\n\n      if (res.ok) {\n        let keys = Object.keys(localStorage);\n\n        for (let key of keys) {\n          if (key !== 'author-name' && key !== 'article-key') {\n            localStorage.removeItem(key);\n          }\n        }\n\n        let openRequest = indexedDB.open('article-store', 2);\n\n        openRequest.onsuccess = async () => {\n          let db = openRequest.result;\n          let tx = db.transaction('photoBuffer', 'readwrite');\n          let store = tx.objectStore('photoBuffer');\n          let keys = store.getAllKeys();\n\n          keys.onsuccess = () => {\n            keys.result.map(key => {\n              if (key !== 'article-author-photo') {\n                store.delete(key);\n                console.log('delete');\n              }\n            });\n            window.location.reload();\n          };\n        };\n      } else {\n        alert(result);\n      }\n    } catch (err) {\n      console.log(err);\n    }\n  };\n\n  const submitForm = e => {\n    e.preventDefault();\n    let data = new FormData(e.target);\n    let content = localStorage.getItem('article-content-object');\n    let fileList = JSON.parse(content).filter(item => item.type === 'photo');\n    fileList.push({\n      key: 'article-author-photo'\n    });\n    let openRequest = indexedDB.open('article-store', 2);\n\n    openRequest.onsuccess = async () => {\n      let db = openRequest.result;\n      let tx = db.transaction('photoBuffer');\n      let store = tx.objectStore('photoBuffer');\n      let reqs = fileList.map(item => new Promise((resolve, reject) => {\n        let photo = store.get(item.key);\n\n        photo.onsuccess = () => {\n          if (photo.result) {\n            resolve({\n              file: photo.result.file,\n              name: item.key\n            });\n          } else {\n            reject('有一个图片板块没有文件。请上传或是删除点这个板块');\n          }\n        };\n      }));\n      Promise.all(reqs).then(items => {\n        items.map(item => {\n          data.append(item.name, item.file);\n        });\n        data.append('article-content-main', content);\n        data.append('link-count', LinkList.length);\n        uploadData(data);\n      }).catch(alert);\n    };\n  };\n\n  const {\n    0: LinkList,\n    1: setLinkList\n  } = useState(['a']);\n  return __jsx(React.Fragment, null, __jsx(Head, null, __jsx(\"title\", {\n    className: \"jsx-1864912321\"\n  }, \"Create Next App\"), __jsx(\"link\", {\n    rel: \"stylesheet\",\n    href: \"https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css\",\n    integrity: \"sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh\",\n    crossorigin: \"anonymous\",\n    className: \"jsx-1864912321\"\n  }), __jsx(\"link\", {\n    rel: \"stylesheet\",\n    href: \"//at.alicdn.com/t/font_1748919_7p01375xskx.css\",\n    className: \"jsx-1864912321\"\n  }), __jsx(\"link\", {\n    rel: \"icon\",\n    href: \"/logo.jpg\",\n    type: \"image/x-icon\",\n    className: \"jsx-1864912321\"\n  })), __jsx(\"div\", {\n    className: \"jsx-1864912321\" + \" \" + \"container-fluid\"\n  }, __jsx(\"nav\", {\n    className: \"jsx-1864912321\"\n  }, __jsx(Nav, null)), __jsx(\"form\", {\n    onSubmit: submitForm,\n    className: \"jsx-1864912321\"\n  }, __jsx(Author, null), __jsx(ArtContent, {\n    setLinkList: setLinkList\n  }), __jsx(About, {\n    List: LinkList\n  })), __jsx(Footer, null)), __jsx(_JSXStyle, {\n    id: \"1864912321\"\n  }, [\"*,body{margin:0;padding:0;box-sizing:border-box;}\", \"html{font-size:10px;}\", \".container-fluid{padding:0;}\"]));\n};\n\nexport default Home;","map":null,"metadata":{},"sourceType":"module"}