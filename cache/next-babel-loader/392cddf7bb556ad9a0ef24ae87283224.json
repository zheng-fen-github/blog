{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _JSXStyle from \"styled-jsx/style\";\nvar __jsx = React.createElement;\nimport React, { useEffect, useState } from 'react';\nimport Head from 'next/head';\nimport Nav from '../component/release-article/nav';\nimport Author from '../component/release-article/author';\nimport ArtContent from '../component/release-article/articleContent';\nimport About from '../component/release-article/about';\nimport Footer from '../component/release-article/footer';\nimport { useRouter } from 'next/router';\n\nvar Home = function Home() {\n  var key = useRouter().query.key; //设置发布的钥匙串\n\n  useEffect(function () {\n    if (key) localStorage.setItem('article-key', key);\n  }, []);\n\n  var uploadData = function uploadData(data) {\n    var QURL, res, result, keys, _i, _keys, _key, openRequest;\n\n    return _regeneratorRuntime.async(function uploadData$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            _context2.prev = 0;\n            QURL = process.env.DATA_URL + 'addArticle/add';\n            _context2.next = 4;\n            return _regeneratorRuntime.awrap(fetch(QURL, {\n              method: 'POST',\n              body: data\n            }));\n\n          case 4:\n            res = _context2.sent;\n            _context2.next = 7;\n            return _regeneratorRuntime.awrap(res.json());\n\n          case 7:\n            result = _context2.sent;\n\n            if (res.ok) {\n              keys = Object.keys(localStorage);\n\n              for (_i = 0, _keys = keys; _i < _keys.length; _i++) {\n                _key = _keys[_i];\n\n                if (_key !== 'author-name' && _key !== 'article-key') {\n                  localStorage.removeItem(_key);\n                }\n              }\n\n              openRequest = indexedDB.open('article-store', 2);\n\n              openRequest.onsuccess = function _callee() {\n                var db, tx, store, keys;\n                return _regeneratorRuntime.async(function _callee$(_context) {\n                  while (1) {\n                    switch (_context.prev = _context.next) {\n                      case 0:\n                        db = openRequest.result;\n                        tx = db.transaction('photoBuffer', 'readwrite');\n                        store = tx.objectStore('photoBuffer');\n                        keys = store.getAllKeys();\n\n                        keys.onsuccess = function () {\n                          keys.result.map(function (key) {\n                            if (key !== 'article-author-photo') {\n                              store[\"delete\"](key);\n                              console.log('delete');\n                            }\n                          });\n                          window.location.reload();\n                        };\n\n                      case 5:\n                      case \"end\":\n                        return _context.stop();\n                    }\n                  }\n                }, null, null, null, Promise);\n              };\n            } else {\n              alert(result);\n            }\n\n            _context2.next = 14;\n            break;\n\n          case 11:\n            _context2.prev = 11;\n            _context2.t0 = _context2[\"catch\"](0);\n            console.log(_context2.t0);\n\n          case 14:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, null, null, [[0, 11]], Promise);\n  };\n\n  var submitForm = function submitForm(e) {\n    e.preventDefault();\n    var data = new FormData(e.target);\n    var content = localStorage.getItem('article-content-object');\n    var fileList = JSON.parse(content).filter(function (item) {\n      return item.type === 'photo';\n    });\n    fileList.push({\n      key: 'article-author-photo'\n    });\n    var openRequest = indexedDB.open('article-store', 2);\n\n    openRequest.onsuccess = function _callee2() {\n      var db, tx, store, reqs;\n      return _regeneratorRuntime.async(function _callee2$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              db = openRequest.result;\n              tx = db.transaction('photoBuffer');\n              store = tx.objectStore('photoBuffer');\n              reqs = fileList.map(function (item) {\n                return new Promise(function (resolve, reject) {\n                  var photo = store.get(item.key);\n\n                  photo.onsuccess = function () {\n                    if (photo.result) {\n                      resolve({\n                        file: photo.result.file,\n                        name: item.key\n                      });\n                    } else {\n                      reject('有一个图片板块没有文件。请上传或是删除点这个板块');\n                    }\n                  };\n                });\n              });\n              Promise.all(reqs).then(function (items) {\n                items.map(function (item) {\n                  data.append(item.name, item.file);\n                });\n                data.append('article-content-main', content);\n                data.append('link-count', LinkList.length);\n                uploadData(data);\n              })[\"catch\"](alert);\n\n            case 5:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, null, null, null, Promise);\n    };\n  };\n\n  var _useState = useState(['a']),\n      LinkList = _useState[0],\n      setLinkList = _useState[1];\n\n  return __jsx(React.Fragment, null, __jsx(Head, null, __jsx(\"title\", {\n    className: \"jsx-1864912321\"\n  }, \"Create Next App\"), __jsx(\"link\", {\n    rel: \"stylesheet\",\n    href: \"https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css\",\n    integrity: \"sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh\",\n    crossorigin: \"anonymous\",\n    className: \"jsx-1864912321\"\n  }), __jsx(\"link\", {\n    rel: \"stylesheet\",\n    href: \"//at.alicdn.com/t/font_1748919_7p01375xskx.css\",\n    className: \"jsx-1864912321\"\n  }), __jsx(\"link\", {\n    rel: \"icon\",\n    href: \"/logo.jpg\",\n    type: \"image/x-icon\",\n    className: \"jsx-1864912321\"\n  })), __jsx(\"div\", {\n    className: \"jsx-1864912321\" + \" \" + \"container-fluid\"\n  }, __jsx(\"nav\", {\n    className: \"jsx-1864912321\"\n  }, __jsx(Nav, null)), __jsx(\"form\", {\n    onSubmit: submitForm,\n    className: \"jsx-1864912321\"\n  }, __jsx(Author, null), __jsx(ArtContent, {\n    setLinkList: setLinkList\n  }), __jsx(About, {\n    List: LinkList\n  })), __jsx(Footer, null)), __jsx(_JSXStyle, {\n    id: \"1864912321\"\n  }, [\"*,body{margin:0;padding:0;box-sizing:border-box;}\", \"html{font-size:10px;}\", \".container-fluid{padding:0;}\"]));\n};\n\nexport default Home;","map":null,"metadata":{},"sourceType":"module"}