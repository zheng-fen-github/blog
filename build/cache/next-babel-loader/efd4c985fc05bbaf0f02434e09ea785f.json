{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _JSXStyle from \"styled-jsx/style\";\nvar __jsx = React.createElement;\nimport React, { useState, useEffect } from 'react';\n\nvar AuthorPhoto = function AuthorPhoto() {\n  var _useState = useState(null),\n      photo = _useState[0],\n      setPhoto = _useState[1];\n\n  var clickEv = function clickEv(e) {\n    e.target.nextElementSibling.click();\n  };\n\n  var clickEv2 = function clickEv2(e) {\n    e.target.previousElementSibling.click();\n  };\n\n  var fileChange = function fileChange(e) {\n    try {\n      var file = e.target.files[0];\n      var img = document.createElement('img');\n      img.src = URL.createObjectURL(file);\n\n      img.onload = function () {\n        document.querySelector('.photo-container').append(img);\n        canvasFunc(img.offsetWidth, img.offsetHeight, img, setPhoto);\n      };\n    } catch (err) {\n      console.log(err);\n    }\n  };\n\n  useEffect(function () {\n    var openRequest = indexedDB.open('article-store', 2);\n\n    openRequest.onupgradeneeded = function () {\n      var db = openRequest.result;\n\n      if (!db.objectStoreNames.contains('photoBuffer')) {\n        db.createObjectStore('photoBuffer', {\n          keyPath: 'name'\n        });\n      }\n    };\n\n    openRequest.onsuccess = function _callee() {\n      var db, tx, store, photo;\n      return _regeneratorRuntime.async(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              db = openRequest.result;\n              tx = db.transaction('photoBuffer');\n              store = tx.objectStore('photoBuffer');\n              photo = store.get('article-author-photo');\n\n              photo.onsuccess = function () {\n                if (photo.result) {\n                  setPhoto(photo.result.file);\n                }\n              };\n\n            case 5:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, null, null, null, Promise);\n    };\n\n    return function () {\n      URL.revokeObjectURL(photo);\n    };\n  }, []);\n  return __jsx(React.Fragment, null, !photo && __jsx(\"div\", {\n    onClick: clickEv,\n    className: \"jsx-2605298663\" + \" \" + \"file-upload-button\"\n  }), __jsx(\"input\", {\n    type: \"file\",\n    name: \"author-photo-file\",\n    onChange: fileChange,\n    className: \"jsx-2605298663\" + \" \" + 'd-none'\n  }), photo && __jsx(\"img\", {\n    src: URL.createObjectURL(photo),\n    alt: \"author-photo\",\n    onClick: clickEv2,\n    className: \"jsx-2605298663\"\n  }), __jsx(\"div\", {\n    style: {\n      position: 'fixed',\n      left: 0,\n      top: 0,\n      visibility: 'hidden',\n      userSelect: 'none'\n    },\n    className: \"jsx-2605298663\" + \" \" + \"photo-container\"\n  }), __jsx(\"canvas\", {\n    id: \"canvas\",\n    hidden: true,\n    className: \"jsx-2605298663\"\n  }), __jsx(\"canvas\", {\n    id: \"canvas2\",\n    hidden: true,\n    className: \"jsx-2605298663\"\n  }), __jsx(_JSXStyle, {\n    id: \"2605298663\"\n  }, [\".file-upload-button.jsx-2605298663{width:80px;height:80px;background:black;cursor:pointer;}\", \"img.jsx-2605298663{cursor:pointer;}\"]));\n};\n\nvar canvasFunc = function canvasFunc(W, H, img, loadPhoto) {\n  var canvas = document.getElementById('canvas');\n  var ctx = canvas.getContext('2d');\n  var count = Math.min(W, H);\n  canvas.width = count;\n  canvas.height = count;\n  var w = (Math.max(W, H) - count) / 2;\n  W > H ? ctx.drawImage(img, -w, 0) : ctx.drawImage(img, 0, -w); //裁减成一比一    \n\n  var ctx2 = document.getElementById('canvas2').getContext('2d');\n  canvas2.width = 80;\n  canvas2.height = 80;\n  ctx2.drawImage(canvas, 0, 0, 80, 80); // 缩放成40px 40px\n\n  document.getElementById('canvas2').toBlob(function (blob) {\n    // 输出图片\n    var name = 'authorPhoto.' + blob.type.slice(6, 9);\n    var file = new File([blob], name);\n    loadPhoto(blob);\n    var openRequest = indexedDB.open('article-store', 2);\n\n    openRequest.onsuccess = function () {\n      var DB = openRequest.result;\n      var transaction = DB.transaction('photoBuffer', 'readwrite');\n      var store = transaction.objectStore(\"photoBuffer\");\n      var photo = store.get('article-author-photo');\n\n      photo.onsuccess = function () {\n        if (photo.result) {\n          store[\"delete\"]('article-author-photo');\n        }\n\n        var bufferItem = {\n          name: 'article-author-photo',\n          file: file,\n          create: new Date()\n        };\n        var req = store.add(bufferItem);\n\n        req.onerror = function () {\n          console.log('存图片buffer 失败');\n          console.log(req.error);\n        };\n      };\n    }; //    let a = document.createElement('a');       \n    //    a.href = URL.createObjectURL(blob);  \n    //    a.download = true;   \n    //    a.click();     \n\n  }, 'image/png');\n};\n\nexport default AuthorPhoto;","map":null,"metadata":{},"sourceType":"module"}